name: Release Asherah-Cobhan

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v1.0.0). Leave empty to build from current commit.'
        required: false
        type: string
      upload_to_release:
        description: 'Upload artifacts to GitHub Release (requires existing release)'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: libasherah_cobhan.so
            asset_name: libasherah-x64.so
            arch: x64
          # Linux arm64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact_name: libasherah_cobhan.so
            asset_name: libasherah-arm64.so
            arch: arm64
            cross: true
          # macOS x86_64 (cross-compile from arm64)
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: libasherah_cobhan.dylib
            asset_name: libasherah-x64.dylib
            arch: x64
          # macOS arm64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: libasherah_cobhan.dylib
            asset_name: libasherah-arm64.dylib
            arch: arm64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ matrix.target }}-cargo-cobhan-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ matrix.target }}-cargo-cobhan-

      - name: Install cross-compile tools (Linux arm64)
        if: matrix.cross == true
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Add Rust target
        run: rustup target add ${{ matrix.target }}

      - name: Build asherah-cobhan
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: ${{ matrix.cross && 'aarch64-linux-gnu-gcc' || '' }}
          CC_aarch64_unknown_linux_gnu: ${{ matrix.cross && 'aarch64-linux-gnu-gcc' || '' }}
          CXX_aarch64_unknown_linux_gnu: ${{ matrix.cross && 'aarch64-linux-gnu-g++' || '' }}
          AR_aarch64_unknown_linux_gnu: ${{ matrix.cross && 'aarch64-linux-gnu-ar' || '' }}
        run: |
          cargo build --release -p asherah-cobhan --target ${{ matrix.target }}

      - name: Strip binary (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            aarch64-linux-gnu-strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }} || true
          else
            strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }} || true
          fi

      - name: Prepare artifact
        run: |
          mkdir -p artifacts
          cp target/${{ matrix.target }}/release/${{ matrix.artifact_name }} artifacts/${{ matrix.asset_name }}

      - name: Generate header file
        run: |
          cat > artifacts/libasherah-${{ matrix.arch }}.h << 'EOF'
          /* libasherah - C ABI for Asherah encryption library
           *
           * This header is compatible with both Go and Rust implementations.
           * Drop-in replacement for github.com/godaddy/asherah-cobhan
           */
          #ifndef LIBASHERAH_H
          #define LIBASHERAH_H

          #include <stdint.h>

          #ifdef __cplusplus
          extern "C" {
          #endif

          /* Error codes */
          #define ERR_NONE                  0
          #define ERR_NULL_PTR             -1
          #define ERR_BUFFER_TOO_LARGE     -2
          #define ERR_BUFFER_TOO_SMALL     -3
          #define ERR_COPY_FAILED          -4
          #define ERR_JSON_DECODE_FAILED   -5
          #define ERR_JSON_ENCODE_FAILED   -6
          #define ERR_ALREADY_INITIALIZED  -100
          #define ERR_BAD_CONFIG           -101
          #define ERR_NOT_INITIALIZED      -102
          #define ERR_ENCRYPT_FAILED       -103
          #define ERR_DECRYPT_FAILED       -104

          /* Cobhan buffer format:
           * - Bytes 0-3: int32_t length (little-endian)
           * - Bytes 4-7: int32_t capacity (little-endian, for output buffers)
           * - Bytes 8+:  data payload
           */

          void Shutdown(void);
          int32_t SetEnv(void* envJson);
          int32_t SetupJson(void* configJson);
          int32_t EstimateBuffer(int32_t dataLen, int32_t partitionLen);

          int32_t Encrypt(
              void* partitionId,
              void* data,
              void* encryptedData,
              void* encryptedKey,
              void* created,
              void* parentKeyId,
              void* parentKeyCreated
          );

          int32_t Decrypt(
              void* partitionId,
              void* encryptedData,
              void* encryptedKey,
              int64_t created,
              void* parentKeyId,
              int64_t parentKeyCreated,
              void* data
          );

          int32_t EncryptToJson(void* partitionId, void* data, void* jsonOutput);
          int32_t DecryptFromJson(void* partitionId, void* jsonInput, void* dataOutput);

          #ifdef __cplusplus
          }
          #endif

          #endif /* LIBASHERAH_H */
          EOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libasherah-${{ matrix.arch }}-${{ matrix.os }}
          path: artifacts/
          if-no-files-found: error
          retention-days: 7

  # Create a combined artifact with all platforms
  package:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: libasherah-*
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          ls -la artifacts/

      - name: Create tarball
        run: |
          cd artifacts
          tar -czvf ../libasherah-all-platforms.tar.gz .

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: libasherah-all-platforms
          path: libasherah-all-platforms.tar.gz
          retention-days: 7

  # Upload to GitHub Release (only on release event or when explicitly requested)
  upload-release:
    needs: build
    if: github.event_name == 'release' || github.event.inputs.upload_to_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: libasherah-*
          merge-multiple: true

      - name: List artifacts for upload
        run: |
          echo "=== Artifacts to upload ==="
          ls -la artifacts/

      - name: Generate SHA256SUMS
        run: |
          cd artifacts
          sha256sum libasherah-*.so libasherah-*.dylib 2>/dev/null > SHA256SUMS || true
          cat SHA256SUMS

      - name: Create combined tarball
        run: |
          cd artifacts
          tar -czvf ../libasherah-all-platforms.tar.gz .

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          files: |
            artifacts/libasherah-x64.so
            artifacts/libasherah-arm64.so
            artifacts/libasherah-x64.dylib
            artifacts/libasherah-arm64.dylib
            artifacts/libasherah-x64.h
            artifacts/libasherah-arm64.h
            artifacts/SHA256SUMS
            libasherah-all-platforms.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Output download URLs (for documentation)
  show-urls:
    needs: upload-release
    if: github.event_name == 'release' || github.event.inputs.upload_to_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Show download URLs
        run: |
          TAG="${{ github.event.inputs.tag || github.ref_name }}"
          REPO="${{ github.repository }}"
          echo ""
          echo "=============================================="
          echo "libasherah Download URLs (Drop-in compatible)"
          echo "=============================================="
          echo ""
          echo "Linux x86_64:"
          echo "  https://github.com/${REPO}/releases/download/${TAG}/libasherah-x64.so"
          echo "  https://github.com/${REPO}/releases/download/${TAG}/libasherah-x64.h"
          echo ""
          echo "Linux arm64:"
          echo "  https://github.com/${REPO}/releases/download/${TAG}/libasherah-arm64.so"
          echo "  https://github.com/${REPO}/releases/download/${TAG}/libasherah-arm64.h"
          echo ""
          echo "macOS x86_64:"
          echo "  https://github.com/${REPO}/releases/download/${TAG}/libasherah-x64.dylib"
          echo ""
          echo "macOS arm64 (Apple Silicon):"
          echo "  https://github.com/${REPO}/releases/download/${TAG}/libasherah-arm64.dylib"
          echo ""
          echo "Checksums:"
          echo "  https://github.com/${REPO}/releases/download/${TAG}/SHA256SUMS"
          echo ""
          echo "All platforms (tarball):"
          echo "  https://github.com/${REPO}/releases/download/${TAG}/libasherah-all-platforms.tar.gz"
          echo ""
          echo "=============================================="
